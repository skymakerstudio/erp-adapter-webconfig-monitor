namespace Tests;
using System.Text.Json;
using AdapterLibrary;

[TestClass]
public class MonitorTests
{

  [TestMethod]
  public void TestG5ToWeb()
  {

    var All_Parts_Response = """[{"Id":"707433796463833993","PartNumber":"ConfigurablePlate1"},{"Id":"707435321177219946","PartNumber":"Rect"},{"Id":"707435482238493977","PartNumber":"Hex"},{"Id":"993513117160949618","PartNumber":"NoHole"}]""";

    var PartConfigurationState_Response = """{"$id":"1","SessionId":"b6ee6341-92ed-483a-85f4-73180bc04c59","ExpiresAt":"2020-01-18T20:55:31.9725877+02:00","CustomerId":"547575408285834014","Comment":null,"PartConfigurationTemplateSnapshotId":"993518285080342797","PartConfigurationTemplateId":"707434354809585488","PartConfigurationTemplateVersion":11,"PartConfigurationId":"1113532685951609556","IsValid":true,"AlternativePreparationCode":"","DiscountPercentage":0,"LockedDiscount":false,"LockedUnitPrice":false,"PartId":"707433796463833993","PriceFormulaFactor":0.01,"Quantity":1,"StandardPrice":{"$id":"2","Amount":0,"CurrencyId":"2"},"UnitPrice":{"$id":"3","Amount":0,"CurrencyId":"2"},"UnitPriceInCompanyCurrency":{"$id":"4","Amount":0,"CurrencyId":"2"},"WeightPerUnit":0,"Sections":[{"$id":"5","Id":"993518285080342789","Description":"Design","Comment":null,"Visible":true,"Sections":[],"Variables":[{"$id":"6","Id":"707434600696463128","Name":"Width","Description":"Width","Comment":null,"Mandatory":true,"HasDefaultValue":false,"Min":100,"Max":2000,"RoundingBase":1,"NumberOfDecimals":0,"UnitId":"541165834165928899","UnitCode":"mm","VariableType":1,"DefaultValue":{"$id":"7","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":100,"DateTimeValue":"0001-01-01T00:00:00"},"ExtraFieldTemplateId":null,"Formula":null,"BindPropertyType":null,"RowIndex":1,"SelectionComment":{"$id":"8","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":0,"ValueSelectionType":0,"Value":{"$id":"9","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":100,"DateTimeValue":"0001-01-01T00:00:00"},"IsAvailable":true,"ValidationResults":[],"SelectionCommentDocumentOverrides":7,"DocumentDisplaySettings":null},{"$id":"10","Id":"707434668342198034","Name":"Depth","Description":"Depth","Comment":null,"Mandatory":true,"HasDefaultValue":false,"Min":100,"Max":2000,"RoundingBase":1,"NumberOfDecimals":0,"UnitId":"541165834165928899","UnitCode":"mm","VariableType":1,"DefaultValue":{"$id":"11","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":100,"DateTimeValue":"0001-01-01T00:00:00"},"ExtraFieldTemplateId":null,"Formula":null,"BindPropertyType":null,"RowIndex":2,"SelectionComment":{"$id":"12","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":0,"ValueSelectionType":0,"Value":{"$id":"13","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":100,"DateTimeValue":"0001-01-01T00:00:00"},"IsAvailable":true,"ValidationResults":[],"SelectionCommentDocumentOverrides":7,"DocumentDisplaySettings":null},{"$id":"14","Id":"707434704849420055","Name":"HoleSize","Description":"Hole size","Comment":null,"Mandatory":true,"HasDefaultValue":false,"Min":5,"Max":100,"RoundingBase":1,"NumberOfDecimals":0,"UnitId":"541165834165928899","UnitCode":"mm","VariableType":1,"DefaultValue":{"$id":"15","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":5,"DateTimeValue":"0001-01-01T00:00:00"},"ExtraFieldTemplateId":null,"Formula":null,"BindPropertyType":null,"RowIndex":4,"SelectionComment":{"$id":"16","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":0,"ValueSelectionType":0,"Value":{"$id":"17","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":5,"DateTimeValue":"0001-01-01T00:00:00"},"IsAvailable":true,"ValidationResults":[],"SelectionCommentDocumentOverrides":7,"DocumentDisplaySettings":null},{"$id":"18","Id":"707434796117475092","Name":"HoleSpacing","Description":"Hole spacing","Comment":null,"Mandatory":true,"HasDefaultValue":false,"Min":1,"Max":50,"RoundingBase":1,"NumberOfDecimals":0,"UnitId":"541165834165928899","UnitCode":"mm","VariableType":1,"DefaultValue":{"$id":"19","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":1,"DateTimeValue":"0001-01-01T00:00:00"},"ExtraFieldTemplateId":null,"Formula":null,"BindPropertyType":null,"RowIndex":5,"SelectionComment":{"$id":"20","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":0,"ValueSelectionType":0,"Value":{"$id":"21","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":1,"DateTimeValue":"0001-01-01T00:00:00"},"IsAvailable":true,"ValidationResults":[],"SelectionCommentDocumentOverrides":7,"DocumentDisplaySettings":null},{"$id":"22","Id":"707434850878308329","Name":"Area","Description":"Area","Comment":null,"Mandatory":false,"HasDefaultValue":false,"Min":null,"Max":null,"RoundingBase":null,"NumberOfDecimals":1,"UnitId":"541165834165928866","UnitCode":"mÂ²","VariableType":1,"DefaultValue":null,"ExtraFieldTemplateId":null,"Formula":"[707434600696463128]*[707434668342198034]/1000000 ","BindPropertyType":null,"RowIndex":6,"SelectionComment":{"$id":"23","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":0,"ValueSelectionType":2,"Value":{"$id":"24","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":0.01,"DateTimeValue":"0001-01-01T00:00:00"},"IsAvailable":true,"ValidationResults":[],"SelectionCommentDocumentOverrides":7,"DocumentDisplaySettings":null},{"$id":"25","Id":"707434979727327203","Name":"Perforation","Description":"Perforation","Comment":null,"Mandatory":false,"HasDefaultValue":false,"Min":null,"Max":null,"RoundingBase":null,"NumberOfDecimals":0,"UnitId":null,"UnitCode":null,"VariableType":1,"DefaultValue":null,"ExtraFieldTemplateId":null,"Formula":"[707435042004352992]*[707434704849420055]*[707434704849420055]/[707434600696463128]*[707434668342198034]/1000000*100","BindPropertyType":null,"RowIndex":7,"SelectionComment":{"$id":"26","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":0,"ValueSelectionType":2,"Value":{"$id":"27","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":0.16,"DateTimeValue":"0001-01-01T00:00:00"},"IsAvailable":true,"ValidationResults":[],"SelectionCommentDocumentOverrides":7,"DocumentDisplaySettings":null},{"$id":"28","Id":"707435042004352992","Name":"nHoles","Description":"Number of holes","Comment":null,"Mandatory":false,"HasDefaultValue":false,"Min":null,"Max":null,"RoundingBase":null,"NumberOfDecimals":0,"UnitId":"541165833092186662","UnitCode":"st.","VariableType":1,"DefaultValue":null,"ExtraFieldTemplateId":null,"Formula":"Floor((([707434600696463128]-50)+[707434796117475092])/([707434704849420055]+[707434796117475092]))\r\n*\r\nFloor((([707434668342198034]-50)+[707434796117475092])/([707434704849420055]+[707434796117475092]))","BindPropertyType":null,"RowIndex":8,"SelectionComment":{"$id":"29","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":0,"ValueSelectionType":2,"Value":{"$id":"30","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":64,"DateTimeValue":"0001-01-01T00:00:00"},"IsAvailable":true,"ValidationResults":[],"SelectionCommentDocumentOverrides":7,"DocumentDisplaySettings":null}],"SelectionGroups":[{"$id":"31","Id":"993518285080342907","CanEditSelectedQuantity":false,"Code":"HoleType1","Comment":null,"Description":"Hole shape","MaximumSelectedQuantity":null,"MaximumSelectedRows":1,"MinimumSelectedQuantity":null,"MinimumSelectedRows":1,"RowIndex":3,"Rows":[{"$id":"32","AlternativePreparationCode":null,"AutoCompleteConfigurationId":null,"Comment":null,"DefaultQuantity":1,"ExtraPercent":0,"HasSelections":false,"Id":"993518285080342908","CloneId":0,"Instruction":null,"IsDefaultSettings":false,"IsForCalculationOnly":false,"MainPartId":null,"MaxQuantity":1,"MinQuantity":1,"PartId":"707435321177219946","Position":null,"QuantityFormula":null,"RowIndex":0,"SetupQuantity":0,"SetupQuantityFormula":null,"ToOperation":10,"DiscountPercentage":0,"LockedDiscount":false,"LockedUnitPrice":false,"PriceFactor":64,"PriceFormulaText":"[707435042004352992]","Quantity":1,"SelectionComment":{"$id":"33","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":30,"UnitPrice":{"$id":"34","Amount":0,"CurrencyId":"2"},"UnitPriceInCompanyCurrency":{"$id":"35","Amount":0,"CurrencyId":"2"},"IsSelected":true,"IsAvailable":true,"ValidationResults":[],"WeightPerUnit":null,"SelectionCommentDocumentOverrides":7},{"$id":"36","AlternativePreparationCode":null,"AutoCompleteConfigurationId":null,"Comment":null,"DefaultQuantity":1,"ExtraPercent":0,"HasSelections":false,"Id":"993518285080342909","CloneId":0,"Instruction":null,"IsDefaultSettings":false,"IsForCalculationOnly":false,"MainPartId":null,"MaxQuantity":1,"MinQuantity":1,"PartId":"707435482238493977","Position":null,"QuantityFormula":null,"RowIndex":1,"SetupQuantity":0,"SetupQuantityFormula":null,"ToOperation":10,"DiscountPercentage":0,"LockedDiscount":false,"LockedUnitPrice":false,"PriceFactor":64,"PriceFormulaText":"[707435042004352992]","Quantity":1,"SelectionComment":{"$id":"37","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":10,"UnitPrice":{"$id":"38","Amount":0,"CurrencyId":"2"},"UnitPriceInCompanyCurrency":{"$id":"39","Amount":0,"CurrencyId":"2"},"IsSelected":false,"IsAvailable":true,"ValidationResults":[],"WeightPerUnit":null,"SelectionCommentDocumentOverrides":7}],"SelectionGroups":[],"SourceVersion":7,"IsAvailable":true,"ValidationResults":[]}],"RowIndex":0}]}""";

    AdapterLibrary.MonitorAPI adapter = new AdapterLibrary.MonitorAPI();

    string result = adapter.configurationToWeb(PartConfigurationState_Response, All_Parts_Response);

    var partExpectedState1 = new
    {
      partNumber = "ConfigurablePlate1",
      valid = true,
      values = new Dictionary<string, double>()
      {
        ["Width"] = 100,
        ["Depth"] = 100,
        ["HoleSize"] = 5,
        ["HoleSpacing"] = 1,
        ["Area"] = 0.01,
        ["Perforation"] = 0.16,
        ["nHoles"] = 64,
      },
      texts = new Dictionary<string, string>(),
      selections = new Dictionary<string, WebSelectionRowItem[]>()
      {
        ["HoleType1"] = [new WebSelectionRowItem("Rect", 1)]
      }
    };
    var expectedResult = JsonSerializer.Serialize(partExpectedState1, new
   System.Text.Json.JsonSerializerOptions()
    {
      DefaultIgnoreCondition = System.Text.Json.Serialization.JsonIgnoreCondition.WhenWritingNull
    });

    var partReferenceIndex = result.IndexOf("partId");
    Assert.AreEqual(partReferenceIndex, -1); // Hide all guids since they tend to change and cannot be referenced
    Assert.AreEqual(result, expectedResult);

  }
  [TestMethod]
  public void TestWebToG5()
  {
    var All_Parts_Response = """[{"Id":"707433796463833993","PartNumber":"ConfigurablePlate1"},{"Id":"707435321177219946","PartNumber":"Rect"},{"Id":"707435482238493977","PartNumber":"Hex"},{"Id":"993513117160949618","PartNumber":"NoHole"}]""";
    var PartConfigurationState_Response = """{"$id":"1","SessionId":"b6ee6341-92ed-483a-85f4-73180bc04c59","ExpiresAt":"2020-01-18T20:55:31.9725877+02:00","CustomerId":"547575408285834014","Comment":null,"PartConfigurationTemplateSnapshotId":"993518285080342797","PartConfigurationTemplateId":"707434354809585488","PartConfigurationTemplateVersion":11,"PartConfigurationId":"1113532685951609556","IsValid":true,"AlternativePreparationCode":"","DiscountPercentage":0,"LockedDiscount":false,"LockedUnitPrice":false,"PartId":"707433796463833993","PriceFormulaFactor":0.01,"Quantity":1,"StandardPrice":{"$id":"2","Amount":0,"CurrencyId":"2"},"UnitPrice":{"$id":"3","Amount":0,"CurrencyId":"2"},"UnitPriceInCompanyCurrency":{"$id":"4","Amount":0,"CurrencyId":"2"},"WeightPerUnit":0,"Sections":[{"$id":"5","Id":"993518285080342789","Description":"Design","Comment":null,"Visible":true,"Sections":[],"Variables":[{"$id":"6","Id":"707434600696463128","Name":"Width","Description":"Width","Comment":null,"Mandatory":true,"HasDefaultValue":false,"Min":100,"Max":2000,"RoundingBase":1,"NumberOfDecimals":0,"UnitId":"541165834165928899","UnitCode":"mm","VariableType":1,"DefaultValue":{"$id":"7","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":100,"DateTimeValue":"0001-01-01T00:00:00"},"ExtraFieldTemplateId":null,"Formula":null,"BindPropertyType":null,"RowIndex":1,"SelectionComment":{"$id":"8","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":0,"ValueSelectionType":0,"Value":{"$id":"9","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":100,"DateTimeValue":"0001-01-01T00:00:00"},"IsAvailable":true,"ValidationResults":[],"SelectionCommentDocumentOverrides":7,"DocumentDisplaySettings":null},{"$id":"10","Id":"707434668342198034","Name":"Depth","Description":"Depth","Comment":null,"Mandatory":true,"HasDefaultValue":false,"Min":100,"Max":2000,"RoundingBase":1,"NumberOfDecimals":0,"UnitId":"541165834165928899","UnitCode":"mm","VariableType":1,"DefaultValue":{"$id":"11","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":100,"DateTimeValue":"0001-01-01T00:00:00"},"ExtraFieldTemplateId":null,"Formula":null,"BindPropertyType":null,"RowIndex":2,"SelectionComment":{"$id":"12","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":0,"ValueSelectionType":0,"Value":{"$id":"13","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":100,"DateTimeValue":"0001-01-01T00:00:00"},"IsAvailable":true,"ValidationResults":[],"SelectionCommentDocumentOverrides":7,"DocumentDisplaySettings":null},{"$id":"14","Id":"707434704849420055","Name":"HoleSize","Description":"Hole size","Comment":null,"Mandatory":true,"HasDefaultValue":false,"Min":5,"Max":100,"RoundingBase":1,"NumberOfDecimals":0,"UnitId":"541165834165928899","UnitCode":"mm","VariableType":1,"DefaultValue":{"$id":"15","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":5,"DateTimeValue":"0001-01-01T00:00:00"},"ExtraFieldTemplateId":null,"Formula":null,"BindPropertyType":null,"RowIndex":4,"SelectionComment":{"$id":"16","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":0,"ValueSelectionType":0,"Value":{"$id":"17","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":5,"DateTimeValue":"0001-01-01T00:00:00"},"IsAvailable":true,"ValidationResults":[],"SelectionCommentDocumentOverrides":7,"DocumentDisplaySettings":null},{"$id":"18","Id":"707434796117475092","Name":"HoleSpacing","Description":"Hole spacing","Comment":null,"Mandatory":true,"HasDefaultValue":false,"Min":1,"Max":50,"RoundingBase":1,"NumberOfDecimals":0,"UnitId":"541165834165928899","UnitCode":"mm","VariableType":1,"DefaultValue":{"$id":"19","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":1,"DateTimeValue":"0001-01-01T00:00:00"},"ExtraFieldTemplateId":null,"Formula":null,"BindPropertyType":null,"RowIndex":5,"SelectionComment":{"$id":"20","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":0,"ValueSelectionType":0,"Value":{"$id":"21","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":1,"DateTimeValue":"0001-01-01T00:00:00"},"IsAvailable":true,"ValidationResults":[],"SelectionCommentDocumentOverrides":7,"DocumentDisplaySettings":null},{"$id":"22","Id":"707434850878308329","Name":"Area","Description":"Area","Comment":null,"Mandatory":false,"HasDefaultValue":false,"Min":null,"Max":null,"RoundingBase":null,"NumberOfDecimals":1,"UnitId":"541165834165928866","UnitCode":"mÂ²","VariableType":1,"DefaultValue":null,"ExtraFieldTemplateId":null,"Formula":"[707434600696463128]*[707434668342198034]/1000000 ","BindPropertyType":null,"RowIndex":6,"SelectionComment":{"$id":"23","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":0,"ValueSelectionType":2,"Value":{"$id":"24","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":0.01,"DateTimeValue":"0001-01-01T00:00:00"},"IsAvailable":true,"ValidationResults":[],"SelectionCommentDocumentOverrides":7,"DocumentDisplaySettings":null},{"$id":"25","Id":"707434979727327203","Name":"Perforation","Description":"Perforation","Comment":null,"Mandatory":false,"HasDefaultValue":false,"Min":null,"Max":null,"RoundingBase":null,"NumberOfDecimals":0,"UnitId":null,"UnitCode":null,"VariableType":1,"DefaultValue":null,"ExtraFieldTemplateId":null,"Formula":"[707435042004352992]*[707434704849420055]*[707434704849420055]/[707434600696463128]*[707434668342198034]/1000000*100","BindPropertyType":null,"RowIndex":7,"SelectionComment":{"$id":"26","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":0,"ValueSelectionType":2,"Value":{"$id":"27","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":0.16,"DateTimeValue":"0001-01-01T00:00:00"},"IsAvailable":true,"ValidationResults":[],"SelectionCommentDocumentOverrides":7,"DocumentDisplaySettings":null},{"$id":"28","Id":"707435042004352992","Name":"nHoles","Description":"Number of holes","Comment":null,"Mandatory":false,"HasDefaultValue":false,"Min":null,"Max":null,"RoundingBase":null,"NumberOfDecimals":0,"UnitId":"541165833092186662","UnitCode":"st.","VariableType":1,"DefaultValue":null,"ExtraFieldTemplateId":null,"Formula":"Floor((([707434600696463128]-50)+[707434796117475092])/([707434704849420055]+[707434796117475092]))\r\n*\r\nFloor((([707434668342198034]-50)+[707434796117475092])/([707434704849420055]+[707434796117475092]))","BindPropertyType":null,"RowIndex":8,"SelectionComment":{"$id":"29","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":0,"ValueSelectionType":2,"Value":{"$id":"30","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":64,"DateTimeValue":"0001-01-01T00:00:00"},"IsAvailable":true,"ValidationResults":[],"SelectionCommentDocumentOverrides":7,"DocumentDisplaySettings":null}],"SelectionGroups":[{"$id":"31","Id":"993518285080342907","CanEditSelectedQuantity":false,"Code":"HoleType1","Comment":null,"Description":"Hole shape","MaximumSelectedQuantity":null,"MaximumSelectedRows":1,"MinimumSelectedQuantity":null,"MinimumSelectedRows":1,"RowIndex":3,"Rows":[{"$id":"32","AlternativePreparationCode":null,"AutoCompleteConfigurationId":null,"Comment":null,"DefaultQuantity":1,"ExtraPercent":0,"HasSelections":false,"Id":"993518285080342908","CloneId":0,"Instruction":null,"IsDefaultSettings":false,"IsForCalculationOnly":false,"MainPartId":null,"MaxQuantity":1,"MinQuantity":1,"PartId":"707435321177219946","Position":null,"QuantityFormula":null,"RowIndex":0,"SetupQuantity":0,"SetupQuantityFormula":null,"ToOperation":10,"DiscountPercentage":0,"LockedDiscount":false,"LockedUnitPrice":false,"PriceFactor":64,"PriceFormulaText":"[707435042004352992]","Quantity":1,"SelectionComment":{"$id":"33","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":30,"UnitPrice":{"$id":"34","Amount":0,"CurrencyId":"2"},"UnitPriceInCompanyCurrency":{"$id":"35","Amount":0,"CurrencyId":"2"},"IsSelected":true,"IsAvailable":true,"ValidationResults":[],"WeightPerUnit":null,"SelectionCommentDocumentOverrides":7},{"$id":"36","AlternativePreparationCode":null,"AutoCompleteConfigurationId":null,"Comment":null,"DefaultQuantity":1,"ExtraPercent":0,"HasSelections":false,"Id":"993518285080342909","CloneId":0,"Instruction":null,"IsDefaultSettings":false,"IsForCalculationOnly":false,"MainPartId":null,"MaxQuantity":1,"MinQuantity":1,"PartId":"707435482238493977","Position":null,"QuantityFormula":null,"RowIndex":1,"SetupQuantity":0,"SetupQuantityFormula":null,"ToOperation":10,"DiscountPercentage":0,"LockedDiscount":false,"LockedUnitPrice":false,"PriceFactor":64,"PriceFormulaText":"[707435042004352992]","Quantity":1,"SelectionComment":{"$id":"37","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":10,"UnitPrice":{"$id":"38","Amount":0,"CurrencyId":"2"},"UnitPriceInCompanyCurrency":{"$id":"39","Amount":0,"CurrencyId":"2"},"IsSelected":false,"IsAvailable":true,"ValidationResults":[],"WeightPerUnit":null,"SelectionCommentDocumentOverrides":7}],"SelectionGroups":[],"SourceVersion":7,"IsAvailable":true,"ValidationResults":[]}],"RowIndex":0}]}""";

    var sessionId = "testSessionId123";
    var configWebState = new
    {
      partNumber = "ConfigurablePlate1",
      valid = true,
      values = new Dictionary<string, double>()
      {
        ["Width"] = 100,
        ["Depth"] = 100,
      },
      selections = new Dictionary<string, WebSelectionRowItem[]>()
      {
        ["HoleType1"] = [new WebSelectionRowItem("Hex", 1)]
      }
    };
    var jsonInputString = JsonSerializer.Serialize(configWebState, new
      System.Text.Json.JsonSerializerOptions()
    {
      DefaultIgnoreCondition = System.Text.Json.Serialization.JsonIgnoreCondition.WhenWritingNull
    });

    AdapterLibrary.MonitorAPI adapter = new AdapterLibrary.MonitorAPI();

    string result = adapter.webToConfigurationInstructions(jsonInputString, sessionId, PartConfigurationState_Response, All_Parts_Response);

    var partExpectedState1 = new
    {
      SessionId = sessionId,
      Instructions = new List<UpdatePartConfigurationInstruction>(){
          new UpdatePartConfigurationInstruction(
            0,
            new VariableUpdate("707434600696463128",
              new VariableValue(1, null, null, 100, null)
            ),
            null
          ),
          new UpdatePartConfigurationInstruction(
            0,
            new VariableUpdate("707434668342198034",
              new VariableValue(1, null, null, 100, null)
            ),
            null
          ),
           new UpdatePartConfigurationInstruction(
            1,
            null,
            new SelectionGroupRowUpdate("993518285080342908", "707435321177219946", false, null)
          ),
           new UpdatePartConfigurationInstruction(
            1,
            null,
            new SelectionGroupRowUpdate("993518285080342909", "707435482238493977", true, 1)
          ),
        }

    };
    var expectedResult = JsonSerializer.Serialize(partExpectedState1, new
      System.Text.Json.JsonSerializerOptions()
    {
      DefaultIgnoreCondition = System.Text.Json.Serialization.JsonIgnoreCondition.WhenWritingNull
    });

    Assert.AreEqual(result, expectedResult);
  }

  [TestMethod]
  public void TestWebToG5_ReusedSelectionRows()
  {
    var All_Parts_Response = """[{"Id":"707433796463833993","PartNumber":"ConfigurablePlate1"},{"Id":"707435321177219946","PartNumber":"Rect"},{"Id":"707435482238493977","PartNumber":"Hex"},{"Id":"993513117160949618","PartNumber":"NoHole"}]""";
    var PartConfigurationState_Response = """{"$id":"1","SessionId":"b6ee6341-92ed-483a-85f4-73180bc04c59","ExpiresAt":"2020-01-18T20:55:31.9725877+02:00","CustomerId":"547575408285834014","Comment":null,"PartConfigurationTemplateSnapshotId":"993518285080342797","PartConfigurationTemplateId":"707434354809585488","PartConfigurationTemplateVersion":11,"PartConfigurationId":"1113532685951609556","IsValid":true,"AlternativePreparationCode":"","DiscountPercentage":0,"LockedDiscount":false,"LockedUnitPrice":false,"PartId":"707433796463833993","PriceFormulaFactor":0.01,"Quantity":1.0,"StandardPrice":{"$id":"2","Amount":0,"CurrencyId":"2"},"UnitPrice":{"$id":"3","Amount":0,"CurrencyId":"2"},"UnitPriceInCompanyCurrency":{"$id":"4","Amount":0,"CurrencyId":"2"},"WeightPerUnit":0,"Sections":[{"$id":"5","Id":"993518285080342789","Description":"Design","Comment":null,"Visible":true,"Sections":[],"Variables":[],"SelectionGroups":[{"$id":"31","Id":"993518285080342907","CanEditSelectedQuantity":false,"Code":"HoleType1","Comment":null,"Description":"Hole shape","MaximumSelectedQuantity":null,"MaximumSelectedRows":1,"MinimumSelectedQuantity":null,"MinimumSelectedRows":1,"RowIndex":3,"Rows":[{"$id":"32","AlternativePreparationCode":null,"AutoCompleteConfigurationId":null,"Comment":null,"DefaultQuantity":1,"ExtraPercent":0,"HasSelections":false,"Id":"993518285080342908","CloneId":0,"Instruction":null,"IsDefaultSettings":false,"IsForCalculationOnly":false,"MainPartId":null,"MaxQuantity":1,"MinQuantity":1,"PartId":"707435321177219946","Position":null,"QuantityFormula":null,"RowIndex":0,"SetupQuantity":0,"SetupQuantityFormula":null,"ToOperation":10,"DiscountPercentage":0,"LockedDiscount":false,"LockedUnitPrice":false,"PriceFactor":64,"PriceFormulaText":"[707435042004352992]","Quantity":1,"SelectionComment":{"$id":"33","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":30,"UnitPrice":{"$id":"34","Amount":0,"CurrencyId":"2"},"UnitPriceInCompanyCurrency":{"$id":"35","Amount":0,"CurrencyId":"2"},"IsSelected":true,"IsAvailable":true,"ValidationResults":[],"WeightPerUnit":null,"SelectionCommentDocumentOverrides":7},{"$id":"36","AlternativePreparationCode":null,"AutoCompleteConfigurationId":null,"Comment":null,"DefaultQuantity":1,"ExtraPercent":0,"HasSelections":false,"Id":"993518285080342909","CloneId":0,"Instruction":null,"IsDefaultSettings":false,"IsForCalculationOnly":false,"MainPartId":null,"MaxQuantity":1,"MinQuantity":1,"PartId":"707435482238493977","Position":null,"QuantityFormula":null,"RowIndex":1,"SetupQuantity":0,"SetupQuantityFormula":null,"ToOperation":10,"DiscountPercentage":0,"LockedDiscount":false,"LockedUnitPrice":false,"PriceFactor":64,"PriceFormulaText":"[707435042004352992]","Quantity":1,"SelectionComment":{"$id":"37","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":10,"UnitPrice":{"$id":"38","Amount":0,"CurrencyId":"2"},"UnitPriceInCompanyCurrency":{"$id":"39","Amount":0,"CurrencyId":"2"},"IsSelected":false,"IsAvailable":true,"ValidationResults":[],"WeightPerUnit":null,"SelectionCommentDocumentOverrides":7}],"SelectionGroups":[],"SourceVersion":7,"IsAvailable":true,"ValidationResults":[]},{"$id":"31","Id":"993518285080342999","CanEditSelectedQuantity":false,"Code":"HoleType2","Comment":null,"Description":"Hole shape 2","MaximumSelectedQuantity":null,"MaximumSelectedRows":1,"MinimumSelectedQuantity":null,"MinimumSelectedRows":1,"RowIndex":3,"Rows":[{"$id":"38","AlternativePreparationCode":null,"AutoCompleteConfigurationId":null,"Comment":null,"DefaultQuantity":1,"ExtraPercent":0,"HasSelections":false,"Id":"993518285080342998","CloneId":0,"Instruction":null,"IsDefaultSettings":false,"IsForCalculationOnly":false,"MainPartId":null,"MaxQuantity":1,"MinQuantity":1,"PartId":"707435321177219946","Position":null,"QuantityFormula":null,"RowIndex":0,"SetupQuantity":0,"SetupQuantityFormula":null,"ToOperation":10,"DiscountPercentage":0,"LockedDiscount":false,"LockedUnitPrice":false,"PriceFactor":64,"PriceFormulaText":"[707435042004352992]","Quantity":1,"SelectionComment":{"$id":"33","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":30,"UnitPrice":{"$id":"34","Amount":0,"CurrencyId":"2"},"UnitPriceInCompanyCurrency":{"$id":"35","Amount":0,"CurrencyId":"2"},"IsSelected":true,"IsAvailable":true,"ValidationResults":[],"WeightPerUnit":null,"SelectionCommentDocumentOverrides":7},{"$id":"42","AlternativePreparationCode":null,"AutoCompleteConfigurationId":null,"Comment":null,"DefaultQuantity":1,"ExtraPercent":0,"HasSelections":false,"Id":"993518285080342999","CloneId":0,"Instruction":null,"IsDefaultSettings":false,"IsForCalculationOnly":false,"MainPartId":null,"MaxQuantity":1,"MinQuantity":1,"PartId":"707435482238493977","Position":null,"QuantityFormula":null,"RowIndex":1,"SetupQuantity":0,"SetupQuantityFormula":null,"ToOperation":10,"DiscountPercentage":0,"LockedDiscount":false,"LockedUnitPrice":false,"PriceFactor":64,"PriceFormulaText":"[707435042004352992]","Quantity":1,"SelectionComment":{"$id":"37","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":10,"UnitPrice":{"$id":"38","Amount":0,"CurrencyId":"2"},"UnitPriceInCompanyCurrency":{"$id":"39","Amount":0,"CurrencyId":"2"},"IsSelected":false,"IsAvailable":true,"ValidationResults":[],"WeightPerUnit":null,"SelectionCommentDocumentOverrides":7}],"SelectionGroups":[],"SourceVersion":7,"IsAvailable":true,"ValidationResults":[]}],"RowIndex":0}]}""";

    var sessionId = "testSessionId123";
    var configWebState = new
    {
      partNumber = "ConfigurablePlate1",
      valid = true,
      values = new Dictionary<string, double>() { },
      selections = new Dictionary<string, WebSelectionRowItem[]>()
      {
        ["HoleType1"] = [new WebSelectionRowItem("Hex", 1)],
        ["HoleType2"] = [new WebSelectionRowItem("Hex", 1)]
      }
    };
    var jsonInputString = JsonSerializer.Serialize(configWebState, new
      System.Text.Json.JsonSerializerOptions()
    {
      DefaultIgnoreCondition = System.Text.Json.Serialization.JsonIgnoreCondition.WhenWritingNull
    });

    AdapterLibrary.MonitorAPI adapter = new AdapterLibrary.MonitorAPI();

    string result = adapter.webToConfigurationInstructions(jsonInputString, sessionId, PartConfigurationState_Response, All_Parts_Response);

    var partExpectedState1 = new
    {
      SessionId = sessionId,
      Instructions = new List<UpdatePartConfigurationInstruction>(){
           new UpdatePartConfigurationInstruction(
            1,
            null,
            new SelectionGroupRowUpdate("993518285080342908", "707435321177219946", false, null)
          ),
           new UpdatePartConfigurationInstruction(
            1,
            null,
            new SelectionGroupRowUpdate("993518285080342909", "707435482238493977", true, 1)
          ),
           new UpdatePartConfigurationInstruction(
            1,
            null,
            new SelectionGroupRowUpdate("993518285080342998", "707435321177219946", false, null)
          ),
           new UpdatePartConfigurationInstruction(
            1,
            null,
            new SelectionGroupRowUpdate("993518285080342999", "707435482238493977", true, 1)
          ),
        }

    };
    var expectedResult = JsonSerializer.Serialize(partExpectedState1, new
      System.Text.Json.JsonSerializerOptions()
    {
      DefaultIgnoreCondition = System.Text.Json.Serialization.JsonIgnoreCondition.WhenWritingNull
    });

    Assert.AreEqual(result, expectedResult);
  }

  [TestMethod]
  public void TestG5ToWeb_Variable_null()
  {

    var All_Parts_Response = """[{"Id":"707433796463833993","PartNumber":"ConfigurablePlate1"},{"Id":"707435321177219946","PartNumber":"Rect"},{"Id":"707435482238493977","PartNumber":"Hex"},{"Id":"993513117160949618","PartNumber":"NoHole"}]""";

    var PartConfigurationState_Response = """{"$id":"1","SessionId":"b6ee6341-92ed-483a-85f4-73180bc04c59","ExpiresAt":"2020-01-18T20:55:31.9725877+02:00","CustomerId":"547575408285834014","Comment":null,"PartConfigurationTemplateSnapshotId":"993518285080342797","PartConfigurationTemplateId":"707434354809585488","PartConfigurationTemplateVersion":11,"PartConfigurationId":"1113532685951609556","IsValid":true,"AlternativePreparationCode":"","DiscountPercentage":0,"LockedDiscount":false,"LockedUnitPrice":false,"PartId":"707433796463833993","PriceFormulaFactor":0.01,"Quantity":1,"StandardPrice":{"$id":"2","Amount":0,"CurrencyId":"2"},"UnitPrice":{"$id":"3","Amount":0,"CurrencyId":"2"},"UnitPriceInCompanyCurrency":{"$id":"4","Amount":0,"CurrencyId":"2"},"WeightPerUnit":0,"Sections":[{"$id":"5","Id":"993518285080342789","Description":"Design","Comment":null,"Visible":true,"Sections":[],"Variables":[{"$id":"6","Id":"707434600696463128","Name":"Width","Description":"Width","Comment":null,"Mandatory":true,"HasDefaultValue":false,"Min":100,"Max":2000,"RoundingBase":1,"NumberOfDecimals":0,"UnitId":"541165834165928899","UnitCode":"mm","VariableType":1,"DefaultValue":{"$id":"7","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":100,"DateTimeValue":"0001-01-01T00:00:00"},"ExtraFieldTemplateId":null,"Formula":null,"BindPropertyType":null,"RowIndex":1,"SelectionComment":{"$id":"8","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":0,"ValueSelectionType":0,"Value":null,"IsAvailable":true,"ValidationResults":[],"SelectionCommentDocumentOverrides":7,"DocumentDisplaySettings":null},{"$id":"10","Id":"707434668342198034","Name":"Depth","Description":"Depth","Comment":null,"Mandatory":true,"HasDefaultValue":false,"Min":100,"Max":2000,"RoundingBase":1,"NumberOfDecimals":0,"UnitId":"541165834165928899","UnitCode":"mm","VariableType":1,"DefaultValue":{"$id":"11","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":100,"DateTimeValue":"0001-01-01T00:00:00"},"ExtraFieldTemplateId":null,"Formula":null,"BindPropertyType":null,"RowIndex":2,"SelectionComment":{"$id":"12","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":0,"ValueSelectionType":0,"Value":{"$id":"13","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":100,"DateTimeValue":"0001-01-01T00:00:00"},"IsAvailable":true,"ValidationResults":[],"SelectionCommentDocumentOverrides":7,"DocumentDisplaySettings":null},{"$id":"14","Id":"707434704849420055","Name":"HoleSize","Description":"Hole size","Comment":null,"Mandatory":true,"HasDefaultValue":false,"Min":5,"Max":100,"RoundingBase":1,"NumberOfDecimals":0,"UnitId":"541165834165928899","UnitCode":"mm","VariableType":1,"DefaultValue":{"$id":"15","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":5,"DateTimeValue":"0001-01-01T00:00:00"},"ExtraFieldTemplateId":null,"Formula":null,"BindPropertyType":null,"RowIndex":4,"SelectionComment":{"$id":"16","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":0,"ValueSelectionType":0,"Value":{"$id":"17","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":5,"DateTimeValue":"0001-01-01T00:00:00"},"IsAvailable":true,"ValidationResults":[],"SelectionCommentDocumentOverrides":7,"DocumentDisplaySettings":null},{"$id":"18","Id":"707434796117475092","Name":"HoleSpacing","Description":"Hole spacing","Comment":null,"Mandatory":true,"HasDefaultValue":false,"Min":1,"Max":50,"RoundingBase":1,"NumberOfDecimals":0,"UnitId":"541165834165928899","UnitCode":"mm","VariableType":1,"DefaultValue":{"$id":"19","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":1,"DateTimeValue":"0001-01-01T00:00:00"},"ExtraFieldTemplateId":null,"Formula":null,"BindPropertyType":null,"RowIndex":5,"SelectionComment":{"$id":"20","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":0,"ValueSelectionType":0,"Value":{"$id":"21","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":1,"DateTimeValue":"0001-01-01T00:00:00"},"IsAvailable":true,"ValidationResults":[],"SelectionCommentDocumentOverrides":7,"DocumentDisplaySettings":null},{"$id":"22","Id":"707434850878308329","Name":"Area","Description":"Area","Comment":null,"Mandatory":false,"HasDefaultValue":false,"Min":null,"Max":null,"RoundingBase":null,"NumberOfDecimals":1,"UnitId":"541165834165928866","UnitCode":"mÂ²","VariableType":1,"DefaultValue":null,"ExtraFieldTemplateId":null,"Formula":"[707434600696463128]*[707434668342198034]/1000000 ","BindPropertyType":null,"RowIndex":6,"SelectionComment":{"$id":"23","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":0,"ValueSelectionType":2,"Value":{"$id":"24","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":0.01,"DateTimeValue":"0001-01-01T00:00:00"},"IsAvailable":true,"ValidationResults":[],"SelectionCommentDocumentOverrides":7,"DocumentDisplaySettings":null},{"$id":"25","Id":"707434979727327203","Name":"Perforation","Description":"Perforation","Comment":null,"Mandatory":false,"HasDefaultValue":false,"Min":null,"Max":null,"RoundingBase":null,"NumberOfDecimals":0,"UnitId":null,"UnitCode":null,"VariableType":1,"DefaultValue":null,"ExtraFieldTemplateId":null,"Formula":"[707435042004352992]*[707434704849420055]*[707434704849420055]/[707434600696463128]*[707434668342198034]/1000000*100","BindPropertyType":null,"RowIndex":7,"SelectionComment":{"$id":"26","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":0,"ValueSelectionType":2,"Value":{"$id":"27","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":0.16,"DateTimeValue":"0001-01-01T00:00:00"},"IsAvailable":true,"ValidationResults":[],"SelectionCommentDocumentOverrides":7,"DocumentDisplaySettings":null},{"$id":"28","Id":"707435042004352992","Name":"nHoles","Description":"Number of holes","Comment":null,"Mandatory":false,"HasDefaultValue":false,"Min":null,"Max":null,"RoundingBase":null,"NumberOfDecimals":0,"UnitId":"541165833092186662","UnitCode":"st.","VariableType":1,"DefaultValue":null,"ExtraFieldTemplateId":null,"Formula":"Floor((([707434600696463128]-50)+[707434796117475092])/([707434704849420055]+[707434796117475092]))\r\n*\r\nFloor((([707434668342198034]-50)+[707434796117475092])/([707434704849420055]+[707434796117475092]))","BindPropertyType":null,"RowIndex":8,"SelectionComment":{"$id":"29","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":0,"ValueSelectionType":2,"Value":{"$id":"30","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":64,"DateTimeValue":"0001-01-01T00:00:00"},"IsAvailable":true,"ValidationResults":[],"SelectionCommentDocumentOverrides":7,"DocumentDisplaySettings":null}],"SelectionGroups":[{"$id":"31","Id":"993518285080342907","CanEditSelectedQuantity":false,"Code":"HoleType1","Comment":null,"Description":"Hole shape","MaximumSelectedQuantity":null,"MaximumSelectedRows":1,"MinimumSelectedQuantity":null,"MinimumSelectedRows":1,"RowIndex":3,"Rows":[{"$id":"32","AlternativePreparationCode":null,"AutoCompleteConfigurationId":null,"Comment":null,"DefaultQuantity":1,"ExtraPercent":0,"HasSelections":false,"Id":"993518285080342908","CloneId":0,"Instruction":null,"IsDefaultSettings":false,"IsForCalculationOnly":false,"MainPartId":null,"MaxQuantity":1,"MinQuantity":1,"PartId":"707435321177219946","Position":null,"QuantityFormula":null,"RowIndex":0,"SetupQuantity":0,"SetupQuantityFormula":null,"ToOperation":10,"DiscountPercentage":0,"LockedDiscount":false,"LockedUnitPrice":false,"PriceFactor":64,"PriceFormulaText":"[707435042004352992]","Quantity":1,"SelectionComment":{"$id":"33","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":30,"UnitPrice":{"$id":"34","Amount":0,"CurrencyId":"2"},"UnitPriceInCompanyCurrency":{"$id":"35","Amount":0,"CurrencyId":"2"},"IsSelected":true,"IsAvailable":true,"ValidationResults":[],"WeightPerUnit":null,"SelectionCommentDocumentOverrides":7},{"$id":"36","AlternativePreparationCode":null,"AutoCompleteConfigurationId":null,"Comment":null,"DefaultQuantity":1,"ExtraPercent":0,"HasSelections":false,"Id":"993518285080342909","CloneId":0,"Instruction":null,"IsDefaultSettings":false,"IsForCalculationOnly":false,"MainPartId":null,"MaxQuantity":1,"MinQuantity":1,"PartId":"707435482238493977","Position":null,"QuantityFormula":null,"RowIndex":1,"SetupQuantity":0,"SetupQuantityFormula":null,"ToOperation":10,"DiscountPercentage":0,"LockedDiscount":false,"LockedUnitPrice":false,"PriceFactor":64,"PriceFormulaText":"[707435042004352992]","Quantity":1,"SelectionComment":{"$id":"37","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":10,"UnitPrice":{"$id":"38","Amount":0,"CurrencyId":"2"},"UnitPriceInCompanyCurrency":{"$id":"39","Amount":0,"CurrencyId":"2"},"IsSelected":false,"IsAvailable":true,"ValidationResults":[],"WeightPerUnit":null,"SelectionCommentDocumentOverrides":7}],"SelectionGroups":[],"SourceVersion":7,"IsAvailable":true,"ValidationResults":[]}],"RowIndex":0}]}""";

    AdapterLibrary.MonitorAPI adapter = new AdapterLibrary.MonitorAPI();

    string result = adapter.configurationToWeb(PartConfigurationState_Response, All_Parts_Response);

    var partExpectedState1 = new
    {
      partNumber = "ConfigurablePlate1",
      valid = true,
      values = new Dictionary<string, double>()
      {
        ["Depth"] = 100,
        ["HoleSize"] = 5,
        ["HoleSpacing"] = 1,
        ["Area"] = 0.01,
        ["Perforation"] = 0.16,
        ["nHoles"] = 64,
      },
      texts = new Dictionary<string, string>(),
      selections = new Dictionary<string, WebSelectionRowItem[]>()
      {
        ["HoleType1"] = [new WebSelectionRowItem("Rect", 1)]
      }
    };
    var expectedResult = JsonSerializer.Serialize(partExpectedState1, new
   System.Text.Json.JsonSerializerOptions()
    {
      DefaultIgnoreCondition = System.Text.Json.Serialization.JsonIgnoreCondition.WhenWritingNull
    });

    var partReferenceIndex = result.IndexOf("partId");
    Assert.AreEqual(partReferenceIndex, -1); // Hide all guids since they tend to change and cannot be referenced
    Assert.AreEqual(result, expectedResult);

  }

  [TestMethod]
  public void TestConfiguratorDefintion()
  {

    var All_Parts_Response = """[{"Id":"707433796463833993","PartNumber":"ConfigurablePlate1"},{"Id":"707435321177219946","PartNumber":"Rect"},{"Id":"707435482238493977","PartNumber":"Hex"},{"Id":"993513117160949618","PartNumber":"NoHole"}]""";

    var PartConfigurationState_Response = """{"$id":"1","SessionId":"b6ee6341-92ed-483a-85f4-73180bc04c59","ExpiresAt":"2020-01-18T20:55:31.9725877+02:00","CustomerId":"547575408285834014","Comment":null,"PartConfigurationTemplateSnapshotId":"993518285080342797","PartConfigurationTemplateId":"707434354809585488","PartConfigurationTemplateVersion":11,"PartConfigurationId":"1113532685951609556","IsValid":true,"AlternativePreparationCode":"","DiscountPercentage":0,"LockedDiscount":false,"LockedUnitPrice":false,"PartId":"707433796463833993","PriceFormulaFactor":0.01,"Quantity":1.0,"StandardPrice":{"$id":"2","Amount":0,"CurrencyId":"2"},"UnitPrice":{"$id":"3","Amount":0,"CurrencyId":"2"},"UnitPriceInCompanyCurrency":{"$id":"4","Amount":0,"CurrencyId":"2"},"WeightPerUnit":0,"Sections":[{"$id":"5","Id":"993518285080342789","Description":"Design","Comment":null,"Visible":true,"Sections":[],"Variables":[{"$id":"6","Id":"707434600696463128","Name":"Width","Description":"Width","Comment":null,"Mandatory":true,"HasDefaultValue":false,"Min":100,"Max":2000,"RoundingBase":1,"NumberOfDecimals":0,"UnitId":"541165834165928899","UnitCode":"mm","VariableType":1,"DefaultValue":{"$id":"7","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":100,"DateTimeValue":"0001-01-01T00:00:00"},"ExtraFieldTemplateId":null,"Formula":null,"BindPropertyType":null,"RowIndex":1,"SelectionComment":{"$id":"8","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":0,"ValueSelectionType":0,"Value":{"$id":"9","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":100,"DateTimeValue":"0001-01-01T00:00:00"},"IsAvailable":true,"ValidationResults":[],"SelectionCommentDocumentOverrides":7,"DocumentDisplaySettings":null},{"$id":"10","Id":"707434668342198034","Name":"Depth","Description":"Depth","Comment":null,"Mandatory":true,"HasDefaultValue":false,"Min":100,"Max":2000,"RoundingBase":1,"NumberOfDecimals":0,"UnitId":"541165834165928899","UnitCode":"mm","VariableType":1,"DefaultValue":{"$id":"11","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":100,"DateTimeValue":"0001-01-01T00:00:00"},"ExtraFieldTemplateId":null,"Formula":null,"BindPropertyType":null,"RowIndex":2,"SelectionComment":{"$id":"12","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":0,"ValueSelectionType":0,"Value":{"$id":"13","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":100,"DateTimeValue":"0001-01-01T00:00:00"},"IsAvailable":true,"ValidationResults":[],"SelectionCommentDocumentOverrides":7,"DocumentDisplaySettings":null},{"$id":"14","Id":"707434704849420055","Name":"HoleSize","Description":"Hole size","Comment":null,"Mandatory":true,"HasDefaultValue":false,"Min":5,"Max":100,"RoundingBase":1,"NumberOfDecimals":0,"UnitId":"541165834165928899","UnitCode":"mm","VariableType":1,"DefaultValue":{"$id":"15","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":5,"DateTimeValue":"0001-01-01T00:00:00"},"ExtraFieldTemplateId":null,"Formula":null,"BindPropertyType":null,"RowIndex":4,"SelectionComment":{"$id":"16","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":0,"ValueSelectionType":0,"Value":{"$id":"17","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":5,"DateTimeValue":"0001-01-01T00:00:00"},"IsAvailable":true,"ValidationResults":[],"SelectionCommentDocumentOverrides":7,"DocumentDisplaySettings":null},{"$id":"18","Id":"707434796117475092","Name":"HoleSpacing","Description":"Hole spacing","Comment":null,"Mandatory":true,"HasDefaultValue":false,"Min":1,"Max":50,"RoundingBase":1,"NumberOfDecimals":0,"UnitId":"541165834165928899","UnitCode":"mm","VariableType":1,"DefaultValue":{"$id":"19","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":1,"DateTimeValue":"0001-01-01T00:00:00"},"ExtraFieldTemplateId":null,"Formula":null,"BindPropertyType":null,"RowIndex":5,"SelectionComment":{"$id":"20","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":0,"ValueSelectionType":0,"Value":{"$id":"21","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":1,"DateTimeValue":"0001-01-01T00:00:00"},"IsAvailable":true,"ValidationResults":[],"SelectionCommentDocumentOverrides":7,"DocumentDisplaySettings":null},{"$id":"22","Id":"707434850878308329","Name":"Area","Description":"Area","Comment":null,"Mandatory":false,"HasDefaultValue":false,"Min":null,"Max":null,"RoundingBase":null,"NumberOfDecimals":1,"UnitId":"541165834165928866","UnitCode":"mÂ²","VariableType":1,"DefaultValue":null,"ExtraFieldTemplateId":null,"Formula":"[707434600696463128]*[707434668342198034]/1000000 ","BindPropertyType":null,"RowIndex":6,"SelectionComment":{"$id":"23","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":0,"ValueSelectionType":2,"Value":{"$id":"24","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":0.01,"DateTimeValue":"0001-01-01T00:00:00"},"IsAvailable":true,"ValidationResults":[],"SelectionCommentDocumentOverrides":7,"DocumentDisplaySettings":null},{"$id":"25","Id":"707434979727327203","Name":"Perforation","Description":"Perforation","Comment":null,"Mandatory":false,"HasDefaultValue":false,"Min":null,"Max":null,"RoundingBase":null,"NumberOfDecimals":0,"UnitId":null,"UnitCode":null,"VariableType":1,"DefaultValue":null,"ExtraFieldTemplateId":null,"Formula":"[707435042004352992]*[707434704849420055]*[707434704849420055]/[707434600696463128]*[707434668342198034]/1000000*100","BindPropertyType":null,"RowIndex":7,"SelectionComment":{"$id":"26","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":0,"ValueSelectionType":2,"Value":{"$id":"27","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":0.16,"DateTimeValue":"0001-01-01T00:00:00"},"IsAvailable":true,"ValidationResults":[],"SelectionCommentDocumentOverrides":7,"DocumentDisplaySettings":null},{"$id":"28","Id":"707435042004352992","Name":"nHoles","Description":"Number of holes","Comment":null,"Mandatory":false,"HasDefaultValue":false,"Min":null,"Max":null,"RoundingBase":null,"NumberOfDecimals":0,"UnitId":"541165833092186662","UnitCode":"st.","VariableType":1,"DefaultValue":null,"ExtraFieldTemplateId":null,"Formula":"Floor((([707434600696463128]-50)+[707434796117475092])/([707434704849420055]+[707434796117475092]))\r\n*\r\nFloor((([707434668342198034]-50)+[707434796117475092])/([707434704849420055]+[707434796117475092]))","BindPropertyType":null,"RowIndex":8,"SelectionComment":{"$id":"29","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":0,"ValueSelectionType":2,"Value":{"$id":"30","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":64,"DateTimeValue":"0001-01-01T00:00:00"},"IsAvailable":true,"ValidationResults":[],"SelectionCommentDocumentOverrides":7,"DocumentDisplaySettings":null}],"SelectionGroups":[{"$id":"31","Id":"993518285080342907","CanEditSelectedQuantity":false,"Code":"HoleType1","Comment":null,"Description":"Hole shape","MaximumSelectedQuantity":null,"MaximumSelectedRows":1,"MinimumSelectedQuantity":null,"MinimumSelectedRows":1,"RowIndex":3,"Rows":[{"$id":"32","AlternativePreparationCode":null,"AutoCompleteConfigurationId":null,"Comment":null,"DefaultQuantity":1,"ExtraPercent":0,"HasSelections":false,"Id":"993518285080342908","CloneId":0,"Instruction":null,"IsDefaultSettings":false,"IsForCalculationOnly":false,"MainPartId":null,"MaxQuantity":1,"MinQuantity":1,"PartId":"707435321177219946","Position":null,"QuantityFormula":null,"RowIndex":0,"SetupQuantity":0,"SetupQuantityFormula":null,"ToOperation":10,"DiscountPercentage":0,"LockedDiscount":false,"LockedUnitPrice":false,"PriceFactor":64,"PriceFormulaText":"[707435042004352992]","Quantity":1,"SelectionComment":{"$id":"33","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":30,"UnitPrice":{"$id":"34","Amount":0,"CurrencyId":"2"},"UnitPriceInCompanyCurrency":{"$id":"35","Amount":0,"CurrencyId":"2"},"IsSelected":true,"IsAvailable":true,"ValidationResults":[],"WeightPerUnit":null,"SelectionCommentDocumentOverrides":7},{"$id":"36","AlternativePreparationCode":null,"AutoCompleteConfigurationId":null,"Comment":null,"DefaultQuantity":1,"ExtraPercent":0,"HasSelections":false,"Id":"993518285080342909","CloneId":0,"Instruction":null,"IsDefaultSettings":false,"IsForCalculationOnly":false,"MainPartId":null,"MaxQuantity":1,"MinQuantity":1,"PartId":"707435482238493977","Position":null,"QuantityFormula":null,"RowIndex":1,"SetupQuantity":0,"SetupQuantityFormula":null,"ToOperation":10,"DiscountPercentage":0,"LockedDiscount":false,"LockedUnitPrice":false,"PriceFactor":64,"PriceFormulaText":"[707435042004352992]","Quantity":1,"SelectionComment":{"$id":"37","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":10,"UnitPrice":{"$id":"38","Amount":0,"CurrencyId":"2"},"UnitPriceInCompanyCurrency":{"$id":"39","Amount":0,"CurrencyId":"2"},"IsSelected":false,"IsAvailable":true,"ValidationResults":[],"WeightPerUnit":null,"SelectionCommentDocumentOverrides":7}],"SelectionGroups":[],"SourceVersion":7,"IsAvailable":true,"ValidationResults":[]}],"RowIndex":0}]}""";

    AdapterLibrary.MonitorAPI adapter = new AdapterLibrary.MonitorAPI();

    string result = adapter.getConfiguratorDefinition(PartConfigurationState_Response, All_Parts_Response);

    var partReferenceIndex = result.IndexOf("Rect");
    Assert.AreNotEqual(partReferenceIndex, -1); // Include PartNumber on SelecgionGroupRow states
  }

  [TestMethod]
  public void TestConfiguratorDefintionWithMissingPartId()
  {

    var All_Parts_Response = """[{"Id":"707433796463833993","PartNumber":"ConfigurablePlate1"},{"Id":"707435321177219946","PartNumber":"Rect"},{"Id":"707435482238493977","PartNumber":"Hex"},{"Id":"993513117160949618","PartNumber":"NoHole"}]""";

    var PartConfigurationState_Response = """{"$id":"1","SessionId":"b6ee6341-92ed-483a-85f4-73180bc04c59","ExpiresAt":"2020-01-18T20:55:31.9725877+02:00","CustomerId":"547575408285834014","Comment":null,"PartConfigurationTemplateSnapshotId":"993518285080342797","PartConfigurationTemplateId":"707434354809585488","PartConfigurationTemplateVersion":11,"PartConfigurationId":"1113532685951609556","IsValid":true,"AlternativePreparationCode":"","DiscountPercentage":0,"LockedDiscount":false,"LockedUnitPrice":false,"PartId":"707433796463833993","PriceFormulaFactor":0.01,"Quantity":1.0,"StandardPrice":{"$id":"2","Amount":0,"CurrencyId":"2"},"UnitPrice":{"$id":"3","Amount":0,"CurrencyId":"2"},"UnitPriceInCompanyCurrency":{"$id":"4","Amount":0,"CurrencyId":"2"},"WeightPerUnit":0,"Sections":[{"$id":"5","Id":"993518285080342789","Description":"Design","Comment":null,"Visible":true,"Sections":[],"Variables":[{"$id":"6","Id":"707434600696463128","Name":"Width","Description":"Width","Comment":null,"Mandatory":true,"HasDefaultValue":false,"Min":100,"Max":2000,"RoundingBase":1,"NumberOfDecimals":0,"UnitId":"541165834165928899","UnitCode":"mm","VariableType":1,"DefaultValue":{"$id":"7","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":100,"DateTimeValue":"0001-01-01T00:00:00"},"ExtraFieldTemplateId":null,"Formula":null,"BindPropertyType":null,"RowIndex":1,"SelectionComment":{"$id":"8","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":0,"ValueSelectionType":0,"Value":{"$id":"9","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":100,"DateTimeValue":"0001-01-01T00:00:00"},"IsAvailable":true,"ValidationResults":[],"SelectionCommentDocumentOverrides":7,"DocumentDisplaySettings":null},{"$id":"10","Id":"707434668342198034","Name":"Depth","Description":"Depth","Comment":null,"Mandatory":true,"HasDefaultValue":false,"Min":100,"Max":2000,"RoundingBase":1,"NumberOfDecimals":0,"UnitId":"541165834165928899","UnitCode":"mm","VariableType":1,"DefaultValue":{"$id":"11","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":100,"DateTimeValue":"0001-01-01T00:00:00"},"ExtraFieldTemplateId":null,"Formula":null,"BindPropertyType":null,"RowIndex":2,"SelectionComment":{"$id":"12","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":0,"ValueSelectionType":0,"Value":{"$id":"13","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":100,"DateTimeValue":"0001-01-01T00:00:00"},"IsAvailable":true,"ValidationResults":[],"SelectionCommentDocumentOverrides":7,"DocumentDisplaySettings":null},{"$id":"14","Id":"707434704849420055","Name":"HoleSize","Description":"Hole size","Comment":null,"Mandatory":true,"HasDefaultValue":false,"Min":5,"Max":100,"RoundingBase":1,"NumberOfDecimals":0,"UnitId":"541165834165928899","UnitCode":"mm","VariableType":1,"DefaultValue":{"$id":"15","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":5,"DateTimeValue":"0001-01-01T00:00:00"},"ExtraFieldTemplateId":null,"Formula":null,"BindPropertyType":null,"RowIndex":4,"SelectionComment":{"$id":"16","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":0,"ValueSelectionType":0,"Value":{"$id":"17","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":5,"DateTimeValue":"0001-01-01T00:00:00"},"IsAvailable":true,"ValidationResults":[],"SelectionCommentDocumentOverrides":7,"DocumentDisplaySettings":null},{"$id":"18","Id":"707434796117475092","Name":"HoleSpacing","Description":"Hole spacing","Comment":null,"Mandatory":true,"HasDefaultValue":false,"Min":1,"Max":50,"RoundingBase":1,"NumberOfDecimals":0,"UnitId":"541165834165928899","UnitCode":"mm","VariableType":1,"DefaultValue":{"$id":"19","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":1,"DateTimeValue":"0001-01-01T00:00:00"},"ExtraFieldTemplateId":null,"Formula":null,"BindPropertyType":null,"RowIndex":5,"SelectionComment":{"$id":"20","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":0,"ValueSelectionType":0,"Value":{"$id":"21","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":1,"DateTimeValue":"0001-01-01T00:00:00"},"IsAvailable":true,"ValidationResults":[],"SelectionCommentDocumentOverrides":7,"DocumentDisplaySettings":null},{"$id":"22","Id":"707434850878308329","Name":"Area","Description":"Area","Comment":null,"Mandatory":false,"HasDefaultValue":false,"Min":null,"Max":null,"RoundingBase":null,"NumberOfDecimals":1,"UnitId":"541165834165928866","UnitCode":"mÂ²","VariableType":1,"DefaultValue":null,"ExtraFieldTemplateId":null,"Formula":"[707434600696463128]*[707434668342198034]/1000000 ","BindPropertyType":null,"RowIndex":6,"SelectionComment":{"$id":"23","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":0,"ValueSelectionType":2,"Value":{"$id":"24","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":0.01,"DateTimeValue":"0001-01-01T00:00:00"},"IsAvailable":true,"ValidationResults":[],"SelectionCommentDocumentOverrides":7,"DocumentDisplaySettings":null},{"$id":"25","Id":"707434979727327203","Name":"Perforation","Description":"Perforation","Comment":null,"Mandatory":false,"HasDefaultValue":false,"Min":null,"Max":null,"RoundingBase":null,"NumberOfDecimals":0,"UnitId":null,"UnitCode":null,"VariableType":1,"DefaultValue":null,"ExtraFieldTemplateId":null,"Formula":"[707435042004352992]*[707434704849420055]*[707434704849420055]/[707434600696463128]*[707434668342198034]/1000000*100","BindPropertyType":null,"RowIndex":7,"SelectionComment":{"$id":"26","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":0,"ValueSelectionType":2,"Value":{"$id":"27","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":0.16,"DateTimeValue":"0001-01-01T00:00:00"},"IsAvailable":true,"ValidationResults":[],"SelectionCommentDocumentOverrides":7,"DocumentDisplaySettings":null},{"$id":"28","Id":"707435042004352992","Name":"nHoles","Description":"Number of holes","Comment":null,"Mandatory":false,"HasDefaultValue":false,"Min":null,"Max":null,"RoundingBase":null,"NumberOfDecimals":0,"UnitId":"541165833092186662","UnitCode":"st.","VariableType":1,"DefaultValue":null,"ExtraFieldTemplateId":null,"Formula":"Floor((([707434600696463128]-50)+[707434796117475092])/([707434704849420055]+[707434796117475092]))\r\n*\r\nFloor((([707434668342198034]-50)+[707434796117475092])/([707434704849420055]+[707434796117475092]))","BindPropertyType":null,"RowIndex":8,"SelectionComment":{"$id":"29","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":0,"ValueSelectionType":2,"Value":{"$id":"30","Type":1,"StringValue":null,"BooleanValue":false,"NumericValue":64,"DateTimeValue":"0001-01-01T00:00:00"},"IsAvailable":true,"ValidationResults":[],"SelectionCommentDocumentOverrides":7,"DocumentDisplaySettings":null}],"SelectionGroups":[{"$id":"31","Id":"993518285080342907","CanEditSelectedQuantity":false,"Code":"HoleType1","Comment":null,"Description":"Hole shape","MaximumSelectedQuantity":null,"MaximumSelectedRows":1,"MinimumSelectedQuantity":null,"MinimumSelectedRows":1,"RowIndex":3,"Rows":[{"$id":"32","AlternativePreparationCode":null,"AutoCompleteConfigurationId":null,"Comment":null,"DefaultQuantity":1,"ExtraPercent":0,"HasSelections":false,"Id":"993518285080342908","CloneId":0,"Instruction":null,"IsDefaultSettings":false,"IsForCalculationOnly":false,"MainPartId":null,"MaxQuantity":1,"MinQuantity":1,"PartId":"707435321177219946","Position":null,"QuantityFormula":null,"RowIndex":0,"SetupQuantity":0,"SetupQuantityFormula":null,"ToOperation":10,"DiscountPercentage":0,"LockedDiscount":false,"LockedUnitPrice":false,"PriceFactor":64,"PriceFormulaText":"[707435042004352992]","Quantity":1,"SelectionComment":{"$id":"33","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":30,"UnitPrice":{"$id":"34","Amount":0,"CurrencyId":"2"},"UnitPriceInCompanyCurrency":{"$id":"35","Amount":0,"CurrencyId":"2"},"IsSelected":true,"IsAvailable":true,"ValidationResults":[],"WeightPerUnit":null,"SelectionCommentDocumentOverrides":7},{"$id":"36","AlternativePreparationCode":null,"AutoCompleteConfigurationId":null,"Comment":null,"DefaultQuantity":1,"ExtraPercent":0,"HasSelections":false,"Id":"993518285080342909","CloneId":0,"Instruction":null,"IsDefaultSettings":false,"IsForCalculationOnly":false,"MainPartId":null,"MaxQuantity":1,"MinQuantity":1,"PartId":"0","Position":null,"QuantityFormula":null,"RowIndex":1,"SetupQuantity":0,"SetupQuantityFormula":null,"ToOperation":10,"DiscountPercentage":0,"LockedDiscount":false,"LockedUnitPrice":false,"PriceFactor":64,"PriceFormulaText":"[707435042004352992]","Quantity":1,"SelectionComment":{"$id":"37","Id":"0","Text":"","RawText":"","HasFileLinks":false,"FileLinks":null},"SelectionType":10,"UnitPrice":{"$id":"38","Amount":0,"CurrencyId":"2"},"UnitPriceInCompanyCurrency":{"$id":"39","Amount":0,"CurrencyId":"2"},"IsSelected":false,"IsAvailable":true,"ValidationResults":[],"WeightPerUnit":null,"SelectionCommentDocumentOverrides":7}],"SelectionGroups":[],"SourceVersion":7,"IsAvailable":true,"ValidationResults":[]}],"RowIndex":0}]}""";

    AdapterLibrary.MonitorAPI adapter = new AdapterLibrary.MonitorAPI();

    string result = adapter.getConfiguratorDefinition(PartConfigurationState_Response, All_Parts_Response);

    var missingPartReferenceIndex = result.IndexOf("Missing");
    var missingPartListReferenceIndex = result.IndexOf("Missing from part list");
    Assert.AreNotEqual(missingPartReferenceIndex, -1);
    Assert.AreNotEqual(missingPartListReferenceIndex, -1);
  }
}
